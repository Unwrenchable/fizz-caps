<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ATOMIC FIZZ • VAULT 77 • MOJAVE MAP</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    /* Base / Pip-Boy inspired UI */
    html,body{height:100%;margin:0;background:#000;font-family:VT323,monospace;color:#00ff41}
    .container{height:100%;padding:12px;box-sizing:border-box}
    .panel{height:100%;border-radius:12px;background:linear-gradient(145deg,#001100,#000);padding:10px;box-shadow:0 0 120px rgba(0,255,65,0.06);display:flex;flex-direction:column;position:relative;overflow:hidden}
    .header{color:#00ff41;text-align:center;padding:6px 0;font-size:1.4rem;border-bottom:1px solid rgba(0,255,65,0.06);display:flex;align-items:center;justify-content:space-between;gap:12px;z-index:10}
    .tabs{display:flex;gap:8px;align-items:center}
    .tab{padding:6px 10px;border-radius:6px;background:rgba(0,0,0,0.25);border:1px solid rgba(0,255,65,0.06);color:#00ff41;font-weight:bold;cursor:pointer;user-select:none}
    .tab.active{background:#002200;border-color:#00ff41}
    .controls{display:flex;gap:8px;align-items:center;justify-content:flex-start;padding:8px 0;flex-wrap:wrap;z-index:10}
    .btn{background:#001100;color:#00ff41;border:2px solid #00ff41;padding:6px 10px;border-radius:6px;cursor:pointer;font-weight:bold}
    .wallet-btn{background:#002200;color:#00ff41;border:2px solid #00ff41;padding:6px 10px;border-radius:6px;cursor:pointer;font-weight:bold}
    #status{color:#00ff41;padding-left:8px;font-size:0.95rem}

    /* Map area */
    .map-wrap{position:relative;flex:1;margin-top:6px;border-radius:10px;overflow:hidden;box-shadow:inset 0 0 60px rgba(0,255,65,0.04)}
    #map{width:100%;height:100%}
    #sectorGrid{position:absolute;inset:8px;border-radius:8px;pointer-events:none;mix-blend-mode:screen;opacity:0.14;
      background:
        linear-gradient(#00ff41 1px, transparent 1px),
        linear-gradient(90deg,#00ff41 1px, transparent 1px);
      background-size:56px 56px,56px 56px;
      background-position:-1px -1px,-1px -1px;
      z-index:6;
    }

    /* Marker shapes */
    .marker-dot{width:14px;height:14px;border-radius:50%;box-shadow:0 0 10px rgba(0,255,65,0.9);border:2px solid #001100;display:block}
    .marker-square{width:14px;height:14px;background:currentColor;display:block;box-shadow:0 0 10px currentColor;border:2px solid #001100}
    .marker-triangle{width:0;height:0;border-left:9px solid transparent;border-right:9px solid transparent;border-bottom:16px solid currentColor;box-shadow:0 0 10px currentColor;display:block}

    .rar-common{color:#00ff41}
    .rar-rare{color:#00ffff}
    .rar-epic{color:#ff8800}
    .rar-legendary{color:#ffff00}

    .player-dot{width:18px;height:18px;border-radius:50%;background:#00ff41;border:3px solid #001100;box-shadow:0 0 18px #00ff41}

    .leaflet-popup-content-wrapper{background:#001100;border:2px solid #00ff41;color:#00ff41}
    .leaflet-popup-content{font-family:monospace;font-weight:bold}

    /* Side panel (for STAT / ITEMS / QUESTS) */
    .side-panel{position:absolute;right:18px;top:72px;width:360px;max-height:64%;background:rgba(0,17,0,0.96);border:2px solid #00ff41;border-radius:10px;padding:12px;overflow:auto;z-index:1200;display:none;backdrop-filter:blur(2px)}
    .side-panel h4{margin:0 0 8px 0;color:#00ff41;font-size:1rem}
    .side-panel .close{position:absolute;right:8px;top:8px;background:transparent;border:1px solid #00ff41;color:#00ff41;padding:4px 6px;border-radius:6px;cursor:pointer}
    .list-item{padding:8px 10px;border-bottom:1px dashed rgba(0,255,65,0.06);font-size:0.95rem;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .muted{opacity:0.7;font-size:0.9rem}
    .quest-meta{display:block;font-size:0.85rem;color:#00ff41;opacity:0.8}
    .quest-actions button{background:#001100;color:#00ff41;border:1px solid #00ff41;padding:6px 8px;border-radius:6px;cursor:pointer;margin-left:6px}
    .quest-accepted{opacity:0.95;border-left:4px solid #00ff41;padding-left:8px}

    /* Pip-Boy scanlines + CRT vignette */
    .crt-vignette{pointer-events:none;position:absolute;inset:0;z-index:200;mix-blend-mode:overlay}
    .scanlines{position:absolute;inset:0;background-image:linear-gradient(rgba(0,0,0,0.06) 50%, rgba(0,0,0,0) 50%);background-size:100% 4px;opacity:0.25;mix-blend-mode:multiply;z-index:210;pointer-events:none}
    .crt-glow{position:absolute;inset:0;background:radial-gradient(ellipse at center, rgba(0,255,65,0.06) 0%, rgba(0,0,0,0.6) 60%);z-index:205;pointer-events:none}
    /* subtle flicker */
    @keyframes flicker { 0% {opacity:0.24} 50% {opacity:0.28} 100% {opacity:0.24} }
    .scanlines{animation:flicker 3s infinite linear}

    /* small screens */
    @media (max-width:900px){ .side-panel{width:300px;right:12px} }
    @media (max-width:640px){ .side-panel{width:260px;right:8px;top:64px} .header{font-size:1.1rem} }

    /* --- Pip‑Boy green: Leaflet zoom control --- */
    .leaflet-control-zoom { box-shadow: none; border-radius: 8px; overflow: hidden; }
    .leaflet-control-zoom a {
      background: #002200;                 /* dark green background */
      color: #00ff41 !important;           /* neon green icon color */
      border: 1px solid rgba(0,255,65,0.12);
      width: 36px;
      height: 36px;
      line-height: 36px;
      text-align: center;
      font-weight: bold;
      font-family: VT323, monospace;
      box-shadow: 0 0 10px rgba(0,255,65,0.06);
      transition: background 120ms ease, color 120ms ease;
    }
    .leaflet-control-zoom a:hover {
      background: #003300;
      color: #baffb0 !important;
    }
    .leaflet-control-zoom.leaflet-bar { margin-left: 10px; margin-top: 10px; }

    /* --- Side panel scrollbar (QUESTS/STAT/ITEMS) --- */
    .side-panel { scrollbar-width: thin; scrollbar-color: #00ff41 rgba(0,0,0,0.18); }

    /* WebKit browsers (Chrome, Edge, Safari) */
    .side-panel::-webkit-scrollbar { width: 8px; }
    .side-panel::-webkit-scrollbar-track { background: rgba(0,0,0,0.12); border-radius:6px; }
    .side-panel::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg,#00ff41,#66ff99);
      border-radius:6px;
      border:2px solid rgba(0,0,0,0.12);
    }
    .side-panel::-webkit-scrollbar-thumb:hover { background: #baffb0; }

    /* --- Page scrollbar (make the browser scrollbar match) --- */
    body { scrollbar-width: thin; scrollbar-color: #00ff41 rgba(0,0,0,0.12); }

    /* WebKit page scrollbar */
    body::-webkit-scrollbar { width: 10px; }
    body::-webkit-scrollbar-track { background: #001100; }
    body::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg,#00ff41,#66ff99);
      border-radius:6px;
      border:2px solid #001100;
    }
    body::-webkit-scrollbar-thumb:hover { background: #baffb0; }

  </style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <div class="header">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="font-weight:bold">ATOMIC FIZZ</div>
          <div style="opacity:0.6">•</div>
          <div>VAULT 77</div>
        </div>

        <div class="tabs" aria-hidden="false">
          <div class="tab" id="tab-stat" data-panel="stat">STAT</div>
          <div class="tab" id="tab-items" data-panel="items">ITEMS</div>
          <div class="tab" id="tab-quests" data-panel="quests">QUESTS</div>
          <div class="tab active" id="tab-map" data-panel="map">MAP</div>
        </div>
      </div>

      <div class="controls" style="margin-top:8px">
        <button class="btn" id="centerBtn">Center on Player</button>
        <button class="btn" id="recenterMojave">Recenter Mojave</button>
        <button class="wallet-btn" id="connectPhantom">Connect Phantom</button>
        <div id="status">Status: ready</div>
      </div>

      <div class="map-wrap" id="mapWrap">
        <div id="map"></div>
        <div id="sectorGrid"></div>

        <!-- CRT overlays -->
        <div class="crt-vignette" aria-hidden="true">
          <div class="crt-glow"></div>
          <div class="scanlines"></div>
        </div>

        <!-- Side panel used by STAT / ITEMS / QUESTS -->
        <div class="side-panel" id="sidePanel" role="dialog" aria-hidden="true">
          <button class="close" id="panelClose">X</button>
          <h4 id="panelTitle">Panel</h4>
          <div id="panelBody"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /************************************************************************
     * Single-file final index.html
     * - Full POI list included
     * - STAT / ITEMS / QUESTS panels
     * - Phantom wallet connect/disconnect
     * - Pip-Boy scanlines + CRT vignette
     * - Zoom and scrollbars recolored to match Pip-Boy green (visual only)
     * - Robust player marker, event delegation, consumable/equip logic, persistence
     ************************************************************************/

    // Player stats and inventory (sample)
    const playerStats = {
      Strength: 4, Perception: 3, Endurance: 3, Charisma: 4, Intelligence: 4, Agility: 2, Luck: 4,
      HP: "86/105", LEVEL: 1, AP: "100/100"
    };

    let inventory = [
      {name:"Stimpak",qty:5,rarity:"common"},
      {name:"RadAway",qty:2,rarity:"rare"},
      {name:"10mm Ammo",qty:120,rarity:"common"},
      {name:"Laser Pistol",qty:1,rarity:"epic"}
    ];

    // Quests sample
    let quests = [
      { id: 'q1', title: "Find Vault 77 Key", desc: "Search the Goodsprings area for the Vault 77 key.", reward: "500 CAPS", state: "available" },
      { id: 'q2', title: "Repair Helios One", desc: "Collect 3 solar cells and return to Helios One.", reward: "Energy Cells", state: "available" },
      { id: 'q3', title: "Clear Dead Wind Cavern", desc: "Eliminate the radscorpion nest inside Dead Wind Cavern.", reward: "Rare loot", state: "accepted" },
      { id: 'q4', title: "Escort Caravan", desc: "Escort the caravan from Nipton to Primm.", reward: "250 CAPS", state: "completed" }
    ];

    // === FULL POI LIST (as provided) ===
    const allLocations = [
  {n:"Goodsprings Saloon",lat:35.8324,lng:-115.4320,lvl:1,rarity:"common"},
  {n:"Primm Rollercoaster",lat:35.6145,lng:-115.3845,lvl:2,rarity:"common"},
  {n:"Novac Motel",lat:35.0525,lng:-114.8247,lvl:5,rarity:"rare"},
  {n:"Hoover Dam",lat:36.016,lng:-114.738,lvl:12,rarity:"epic"},
  {n:"The Strip Gate",lat:36.1147,lng:-115.1728,lvl:15,rarity:"epic"},
  {n:"Lucky 38",lat:36.147,lng:-115.156,lvl:18,rarity:"epic"},
  {n:"Black Mountain",lat:35.9310,lng:-115.0440,lvl:20,rarity:"epic"},
  {n:"Area 51 Gate",lat:37.2431,lng:-115.7930,lvl:45,rarity:"legendary"},
  {n:"Vault 77 (Secret)",lat:36.170,lng:-115.140,lvl:77,rarity:"legendary"},
  {n:"Chernobyl Pripyat",lat:51.389,lng:30.099,lvl:99,rarity:"legendary"},
  {n:"Fukushima Daiichi",lat:37.421,lng:141.032,lvl:99,rarity:"legendary"},
  {n:"Three Mile Island",lat:40.1522,lng:-77.1581,lvl:40,rarity:"legendary"},
  {n:"Dead Wind Cavern",lat:35.8000,lng:-115.4000,lvl:40,rarity:"legendary"},
  {n:"Vault 34",lat:36.1750,lng:-114.7500,lvl:20,rarity:"epic"},
  {n:"Jacobstown",lat:36.3000,lng:-115.6500,lvl:22,rarity:"rare"},
  {n:"Searchlight Church",lat:35.46434,lng:-114.91844,lvl:10,rarity:"rare"},
  {n:"Cottonwood Cove",lat:35.9990,lng:-114.5000,lvl:14,rarity:"rare"},
  {n:"Deathclaw Promontory",lat:36.1000,lng:-114.9000,lvl:45,rarity:"legendary"},
  {n:"Los Alamos Lab",lat:35.875,lng:-106.300,lvl:50,rarity:"legendary"},
  {n:"Yucca Mountain",lat:37.000,lng:-116.800,lvl:50,rarity:"legendary"},
  {n:"Nevada Test Site",lat:37.100,lng:-116.000,lvl:48,rarity:"legendary"},
  {n:"Trinity Test Site",lat:33.6773,lng:-106.4754,lvl:80,rarity:"legendary"},
  {n:"Hanford Site",lat:46.549,lng:-119.476,lvl:55,rarity:"legendary"},
  {n:"Pantex Plant",lat:35.311,lng:-101.560,lvl:65,rarity:"legendary"},
  {n:"Oak Ridge Y-12",lat:35.990,lng:-84.250,lvl:50,rarity:"legendary"},
  {n:"Rocky Flats Plant",lat:39.892,lng:-105.202,lvl:45,rarity:"legendary"},
  {n:"Windscale Sellafield",lat:54.417,lng:-3.487,lvl:60,rarity:"legendary"},
  {n:"Kyshtym Disaster",lat:55.767,lng:60.867,lvl:70,rarity:"legendary"},
  {n:"Nipton Trading Post",lat:35.46667,lng:-115.27222,lvl:4,rarity:"common"},
  {n:"Boulder City Hotel",lat:35.97750,lng:-114.83639,lvl:6,rarity:"rare"},
  {n:"New Vegas Strip",lat:36.112740,lng:-115.174301,lvl:10,rarity:"epic"},
  {n:"Freeside Market",lat:36.170719,lng:-115.143929,lvl:5,rarity:"common"},
  {n:"Red Rock Canyon",lat:36.13514,lng:-115.4283,lvl:8,rarity:"rare"},
  {n:"Nellis Air Force Base",lat:36.2361,lng:-115.0342,lvl:25,rarity:"epic"},
  {n:"Helios One",lat:35.7580,lng:-114.9530,lvl:13,rarity:"epic"},
  {n:"REPCONN Test Site",lat:36.0360,lng:-115.0880,lvl:12,rarity:"rare"},
  {n:"Quarry Junction",lat:35.9200,lng:-115.1800,lvl:35,rarity:"epic"},
  {n:"Bonnie Springs Ranch",lat:36.06007,lng:-115.45027,lvl:7,rarity:"common"},
  {n:"Callville Bay Marina",lat:36.14400,lng:-114.72200,lvl:9,rarity:"common"},
  {n:"Sloan Station",lat:35.94361,lng:-115.21722,lvl:5,rarity:"common"},
  {n:"Jean Airport",lat:35.7677,lng:-115.3245,lvl:6,rarity:"common"},
  {n:"McCarran Airport",lat:36.0801,lng:-115.1522,lvl:8,rarity:"rare"},
  {n:"Old Mormon Fort",lat:36.1694,lng:-115.1305,lvl:6,rarity:"common"},
  {n:"Ultra-Luxe Casino",lat:36.0972,lng:-115.1787,lvl:11,rarity:"epic"},
  {n:"Gomorrah Casino",lat:36.1100,lng:-115.1720,lvl:10,rarity:"epic"},
  {n:"Silver Rush",lat:36.1498,lng:-115.1390,lvl:9,rarity:"rare"},
  {n:"Atomic Wrangler",lat:36.1499,lng:-115.1383,lvl:8,rarity:"rare"},
  {n:"Nelson Ghost Town",lat:35.4189,lng:-114.7133,lvl:9,rarity:"rare"},
  {n:"Rhyolite Ghost Town",lat:36.9033,lng:-116.8283,lvl:11,rarity:"rare"},
  {n:"Mt Charleston",lat:36.2650,lng:-115.6500,lvl:16,rarity:"epic"},
  {n:"Luxor Pyramid",lat:36.0965,lng:-115.1769,lvl:9,rarity:"rare"},
  {n:"Whiskey Pete's",lat:35.6167,lng:-115.3900,lvl:3,rarity:"common"},
  {n:"Primm Valley Resort",lat:35.6160,lng:-115.3900,lvl:3,rarity:"common"},
  {n:"Westgate Hotel",lat:36.1311,lng:-115.1564,lvl:10,rarity:"epic"},
  {n:"Coca Cola Factory",lat:36.1025,lng:-115.1738,lvl:8,rarity:"rare"},
  {n:"Nellis Solar Array",lat:36.2460,lng:-115.0320,lvl:15,rarity:"epic"},
  {n:"Ivanpah Solar",lat:35.2000,lng:-115.4667,lvl:18,rarity:"epic"},
  {n:"REPCONN Headquarters",lat:36.0500,lng:-115.1000,lvl:13,rarity:"rare"},
  {n:"188 Trading Post",lat:35.9500,lng:-115.2000,lvl:8,rarity:"common"},
  {n:"Nevada Highway Patrol",lat:35.9500,lng:-115.1500,lvl:6,rarity:"common"},
  {n:"Sunset Sarsaparilla HQ",lat:36.0000,lng:-115.2000,lvl:10,rarity:"rare"},
  {n:"HELIOS One Entrance",lat:35.7600,lng:-114.9500,lvl:13,rarity:"epic"},
  {n:"Camp Searchlight",lat:35.4600,lng:-114.9200,lvl:11,rarity:"rare"},
  {n:"Vikki & Vance Museum",lat:35.6150,lng:-115.3850,lvl:4,rarity:"common"},
  {n:"Mesquite Mountains",lat:35.8500,lng:-115.9500,lvl:17,rarity:"rare"},
  {n:"Devil's Gullet",lat:35.7000,lng:-115.3000,lvl:23,rarity:"epic"},
  {n:"Primm Schoolhouse",lat:35.6150,lng:-115.3850,lvl:3,rarity:"common"},
  {n:"Nipton Hall",lat:35.4667,lng:-115.2722,lvl:5,rarity:"common"},
  {n:"Boulder City Ruins",lat:35.9775,lng:-114.8364,lvl:7,rarity:"rare"},
  {n:"Minuteman III Silo",lat:41.133,lng:-104.867,lvl:70,rarity:"legendary"},
  {n:"Mothership Zeta",lat:0,lng:0,lvl:99,rarity:"legendary"},
  {n:"Dunwich Borers Quarry",lat:42.374,lng:-71.433,lvl:45,rarity:"legendary"},
  {n:"UFO Crash Site",lat:37.644,lng:-116.850,lvl:50,rarity:"legendary"},
  {n:"Havasu Falls",lat:36.240,lng:-112.690,lvl:30,rarity:"rare"},
  {n:"The Devil’s Throat",lat:36.100,lng:-114.900,lvl:40,rarity:"legendary"},
  {n:"Sunken Vault 22",lat:36.1699,lng:-115.1398,lvl:35,rarity:"epic"},
  {n:"The Divide",lat:37.000,lng:-116.000,lvl:55,rarity:"legendary"},
  {n:"Vault 3",lat:36.2000,lng:-115.8000,lvl:25,rarity:"rare"},
  {n:"Vault 11",lat:35.5000,lng:-117.0000,lvl:28,rarity:"epic"},
  {n:"Vault 19",lat:36.1000,lng:-115.9000,lvl:22,rarity:"rare"},
  {n:"Vault 21",lat:36.1699,lng:-115.1398,lvl:18,rarity:"rare"},
  {n:"Vault 22",lat:36.1699,lng:-115.1398,lvl:32,rarity:"epic"},
  {n:"Vault 29",lat:36.0000,lng:-116.0000,lvl:30,rarity:"rare"},
  {n:"Enclave Oil Rig",lat:33.000,lng:-118.000,lvl:50,rarity:"legendary"},
  {n:"Gecko Reactor",lat:37.8000,lng:-121.9000,lvl:25,rarity:"rare"},
  {n:"Klamath",lat:42.0000,lng:-121.8000,lvl:10,rarity:"common"},
  {n:"The Den",lat:37.7749,lng:-122.4194,lvl:14,rarity:"rare"},
  {n:"Modoc",lat:41.6331,lng:-120.0294,lvl:16,rarity:"common"},
  {n:"Ghost Farm",lat:41.5000,lng:-120.0000,lvl:12,rarity:"rare"},
  {n:"Redding Mines",lat:40.6066,lng:-122.1488,lvl:20,rarity:"rare"},
  {n:"NCR Capital",lat:36.1699,lng:-115.1398,lvl:30,rarity:"epic"},
  {n:"Brotherhood Bunker",lat:34.0522,lng:-118.2437,lvl:35,rarity:"epic"},
  {n:"Sierra Army Depot",lat:40.0000,lng:-120.0000,lvl:38,rarity:"epic"},
  {n:"EPA Facility",lat:38.000,lng:-122.0000,lvl:25,rarity:"rare"},
  {n:"The Master's Lair",lat:34.0522,lng:-118.2437,lvl:60,rarity:"legendary"},
  {n:"Cazador Hive",lat:36.0000,lng:-115.0000,lvl:30,rarity:"epic"},
  {n:"Deathclaw Nest",lat:42.0000,lng:-126.0000,lvl:40,rarity:"legendary"},
  {n:"Radscorpion Den",lat:43.0000,lng:-127.0000,lvl:25,rarity:"rare"},
  {n:"Raider Stronghold",lat:37.0000,lng:-121.0000,lvl:22,rarity:"rare"},
  {n:"Super Mutant Base",lat:41.0000,lng:-125.0000,lvl:35,rarity:"epic"},
  {n:"Abandoned Mine",lat:40.0000,lng:-124.0000,lvl:20,rarity:"common"},
  {n:"Scavenger Camp",lat:39.0000,lng:-123.0000,lvl:12,rarity:"common"},
  {n:"Raided Caravan",lat:37.0000,lng:-121.0000,lvl:10,rarity:"common"},
  {n:"Sulphur Pits",lat:40.0000,lng:-122.0000,lvl:22,rarity:"rare"},
  {n:"Shale Bridge",lat:37.7749,lng:-122.4194,lvl:8,rarity:"common"},
  {n:"Andale",lat:38.900,lng:-77.120,lvl:8,rarity:"rare"},
  {n:"Arefu",lat:38.920,lng:-77.180,lvl:6,rarity:"common"},
  {n:"Arlington Cemetery",lat:38.880,lng:-77.070,lvl:20,rarity:"epic"},
  {n:"Springvale School",lat:38.910,lng:-77.310,lvl:8,rarity:"common"},
  {n:"Super-Duper Mart",lat:38.920,lng:-77.290,lvl:6,rarity:"common"},
  {n:"Grayditch",lat:38.880,lng:-77.170,lvl:10,rarity:"rare"},
  {n:"Minefield",lat:38.860,lng:-77.130,lvl:12,rarity:"rare"},
  {n:"Old Olney",lat:39.050,lng:-77.150,lvl:22,rarity:"epic"},
  {n:"Germantown Police",lat:38.970,lng:-77.170,lvl:18,rarity:"rare"},
  {n:"Murder Pass",lat:39.000,lng:-77.200,lvl:20,rarity:"epic"},
  {n:"Turtledove Detention Camp",lat:38.100,lng:-76.400,lvl:18,rarity:"rare"},
  {n:"Bunker Hill",lat:42.370,lng:-71.070,lvl:15,rarity:"rare"},
  {n:"Trinity Plaza",lat:42.360,lng:-71.060,lvl:22,rarity:"epic"},
  {n:"Vault 95",lat:42.100,lng:-71.500,lvl:28,rarity:"epic"},
  {n:"Spectacle Island",lat:42.350,lng:-70.950,lvl:25,rarity:"rare"},
  {n:"Appalachian Workshop",lat:38.200,lng:-80.000,lvl:12,rarity:"common"},
  {n:"Toxic Valley",lat:38.400,lng:-80.200,lvl:22,rarity:"rare"},
  {n:"Ash Heap",lat:37.700,lng:-81.100,lvl:18,rarity:"rare"},
  {n:"Savannah River Site",lat:33.247,lng:-81.402,lvl:50,rarity:"legendary"},
  {n:"Fernald Feed Materials",lat:39.290,lng:-84.680,lvl:40,rarity:"legendary"},
  {n:"Malmstrom AFB Silo Field",lat:47.5047,lng:-111.1833,lvl:70,rarity:"legendary"},
  {n:"Minot AFB Silo Field",lat:48.4167,lng:-101.3586,lvl:72,rarity:"legendary"},
  {n:"F.E. Warren AFB Silo Field",lat:41.1333,lng:-104.8667,lvl:74,rarity:"legendary"},
  {n:"Vandenberg Space Force Base",lat:34.7333,lng:-120.5667,lvl:65,rarity:"legendary"},
  {n:"Ellsworth AFB Silo Cluster",lat:44.1450,lng:-103.1036,lvl:68,rarity:"legendary"},
  {n:"Whiteman AFB Silo",lat:38.7303,lng:-93.5583,lvl:66,rarity:"legendary"},
  {n:"Dombarovsky (Yasny)",lat:51.0333,lng:59.8667,lvl:78,rarity:"legendary"},
  {n:"Tatishchevo",lat:51.6667,lng:45.5667,lvl:80,rarity:"legendary"},
  {n:"Uzhur-4",lat:55.3167,lng:89.8333,lvl:77,rarity:"legendary"},
  {n:"Kozelsk",lat:54.0333,lng:35.7667,lvl:75,rarity:"legendary"},
  {n:"Yoshkar-Ola",lat:56.6333,lng:47.8833,lvl:73,rarity:"legendary"},
  {n:"Yumen Silo Field",lat:40.2667,lng:97.0167,lvl:85,rarity:"legendary"},
  {n:"Hami Silo Field",lat:42.8000,lng:93.5000,lvl:84,rarity:"legendary"},
  {n:"Lop Nur Silos",lat:40.7167,lng:89.7667,lvl:88,rarity:"legendary"},
  {n:"Delingha Silo Field",lat:37.3667,lng:97.3667,lvl:82,rarity:"legendary"},
  {n:"Zaporizhzhia NPP",lat:47.5122,lng:34.5844,lvl:60,rarity:"legendary"},
  {n:"Kashiwazaki-Kariwa",lat:37.4283,lng:138.6017,lvl:70,rarity:"legendary"},
  {n:"Bruce Nuclear",lat:44.3267,lng:-81.5997,lvl:55,rarity:"epic"},
  {n:"Gravelines NPP",lat:51.0153,lng:2.1358,lvl:52,rarity:"epic"},
  {n:"Cattenom NPP",lat:49.4167,lng:6.2167,lvl:50,rarity:"epic"},
  {n:"Kudankulam NPP",lat:8.1689,lng:77.7125,lvl:58,rarity:"epic"},
  {n:"Tianwan NPP",lat:34.6869,lng:119.4600,lvl:56,rarity:"epic"},
  {n:"Olkiluoto NPP",lat:61.2333,lng:21.4500,lvl:54,rarity:"epic"},
  {n:"Hanul NPP",lat:37.0933,lng:129.3833,lvl:53,rarity:"epic"},
  {n:"Paks NPP",lat:46.5667,lng:18.8500,lvl:48,rarity:"epic"},
  {n:"Semipalatinsk Test Site",lat:50.4333,lng:78.7500,lvl:90,rarity:"legendary"},
  {n:"Novaya Zemlya",lat:73.5000,lng:54.0000,lvl:95,rarity:"legendary"},
  {n:"Bikini Atoll",lat:11.6000,lng:165.3833,lvl:92,rarity:"legendary"},
  {n:"Enewetak Atoll",lat:11.3500,lng:162.3500,lvl:90,rarity:"legendary"},
  {n:"Maralinga Test Site",lat:-30.1667,lng:131.6167,lvl:85,rarity:"legendary"},
  {n:"Reggane Test Site",lat:26.7167,lng:0.0500,lvl:82,rarity:"legendary"},
  {n:"Fangataufa Atoll",lat:-22.2333,lng:-138.7500,lvl:88,rarity:"legendary"},
  {n:"Mayak Production Facility (Kyshtym)",lat:55.7167,lng:60.8500,lvl:99,rarity:"legendary"},
  {n:"Windscale Piles",lat:54.4167,lng:-3.5000,lvl:80,rarity:"legendary"},
  {n:"Santa Susana Field Lab",lat:34.2333,lng:-118.7000,lvl:75,rarity:"legendary"},
  {n:"Church Rock Uranium Spill",lat:35.5667,lng:-108.6167,lvl:70,rarity:"legendary"},
  {n:"Goiânia Radiation Accident",lat:-16.6667,lng:-49.2667,lvl:85,rarity:"legendary"},
  {n:"Cheyenne Mountain Complex",lat:38.7442,lng:-104.8467,lvl:80,rarity:"legendary"},
  {n:"Raven Rock Site R",lat:39.7300,lng:-77.4192,lvl:82,rarity:"legendary"},
  {n:"Mount Weather",lat:39.0642,lng:-77.8883,lvl:78,rarity:"legendary"},
  {n:"Sedan Crater",lat:37.1769,lng:-116.0461,lvl:99,rarity:"legendary"},
  {n:"Tsar Bomba Ground Zero",lat:73.4828,lng:54.6333,lvl:99,rarity:"legendary"},
  {n:"Castle Bravo Crater",lat:11.7000,lng:165.2833,lvl:99,rarity:"legendary"}
];

    // === Map init
    const map = L.map('map', { zoomControl: true, attributionControl: false }).setView([36.17, -115.14], 8);

    // Tiles with fallback
    const googleTiles = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { maxZoom: 20 });
    const osmTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });

    let tilesLoaded = false;
    googleTiles.on('load', () => {
      tilesLoaded = true;
      document.getElementById('status').textContent = 'Status: map loaded';
      setTimeout(()=>map.invalidateSize(), 250);
    });
    googleTiles.on('tileerror', () => {
      if (!tilesLoaded) {
        osmTiles.addTo(map);
        document.getElementById('status').textContent = 'Status: using OSM fallback';
        setTimeout(()=>map.invalidateSize(),250);
      }
    });
    googleTiles.addTo(map);

    // containers
    let markers = {};
    let playerMarker = null;
    let playerLatLng = null;
    let claimed = new Set();
    let connectedWallet = null;

    // shaped icons
    function createShapeIcon(rarity, shape) {
      const cls = rarity === 'legendary' ? 'rar-legendary' : rarity === 'epic' ? 'rar-epic' : rarity === 'rare' ? 'rar-rare' : 'rar-common';
      let html = '';
      if (shape === 'dot') html = `<div class="marker-dot ${cls}"></div>`;
      else if (shape === 'square') html = `<div class="marker-square ${cls}"></div>`;
      else html = `<div class="marker-triangle ${cls}"></div>`;
      return L.divIcon({ html, className: '', iconSize: [18,18], iconAnchor: [9,9] });
    }
    function shapeForRarity(rarity) { if (rarity === 'legendary') return 'square'; if (rarity === 'epic') return 'triangle'; return 'dot'; }

    function loadLocations() {
      Object.values(markers).forEach(m => map.removeLayer(m));
      markers = {};
      allLocations.forEach(loc => {
        if (typeof loc.lat !== 'number' || typeof loc.lng !== 'number') return;
        const shape = shapeForRarity(loc.rarity);
        const icon = createShapeIcon(loc.rarity, shape);
        const key = `${loc.n}|${loc.lat}|${loc.lng}`;
        const m = L.marker([loc.lat, loc.lng], { icon }).addTo(map);
        m.bindPopup(`<b style="color:#00ff41">${loc.n}</b><br>Rarity: ${String(loc.rarity).toUpperCase()} • Level ${loc.lvl}`);
        markers[key] = m;
        if (claimed.has(loc.n) && m.setIcon) {
          const dimHtml = `<div class="${shape==='dot'?'marker-dot':shape==='square'?'marker-square':'marker-triangle'}" style="opacity:0.35;color:#003300"></div>`;
          m.setIcon(L.divIcon({ html: dimHtml, className:'', iconSize:[18,18], iconAnchor:[9,9] }));
        }
      });
      setTimeout(()=>map.invalidateSize(), 200);
    }

    // Robust player marker creation
    function ensurePlayerMarker(lat, lng) {
      playerLatLng = L.latLng(lat, lng);
      try {
        if (!playerMarker || !map.hasLayer(playerMarker)) {
          if (playerMarker) try { map.removeLayer(playerMarker); } catch(e){}
          const pip = L.divIcon({ html: '<div class="player-dot"></div>', className: '', iconSize: [22,22], iconAnchor: [11,11] });
          playerMarker = L.marker([lat, lng], { icon: pip }).addTo(map).bindPopup("You");
        } else {
          playerMarker.setLatLng(playerLatLng);
        }
      } catch (err) {
        // fallback: create new marker
        const pip = L.divIcon({ html: '<div class="player-dot"></div>', className: '', iconSize: [22,22], iconAnchor: [11,11] });
        playerMarker = L.marker([lat, lng], { icon: pip }).addTo(map).bindPopup("You");
      }
    }

    document.getElementById('centerBtn').addEventListener('click', () => {
      if (playerLatLng) map.flyTo(playerLatLng, 16, { duration: 0.6 });
      else document.getElementById('status').textContent = 'Status: player not available';
    });
    document.getElementById('recenterMojave').addEventListener('click', () => { map.flyTo([36.17, -115.14], 8, { duration: 0.6 }); });

    // Claim nearest marker on click
    map.on('click', e => {
      let closest = null, minDist = 250;
      Object.keys(markers).forEach(key => {
        const layer = markers[key];
        if (!layer || !layer.getLatLng) return;
        const d = map.distance(e.latlng, layer.getLatLng());
        if (d < minDist) { minDist = d; closest = key; }
      });
      if (closest) {
        const name = closest.split('|')[0];
        if (!claimed.has(name)) {
          claimed.add(name);
          document.getElementById('status').textContent = `Claimed ${name} — +250 CAPS`;
          const layer = markers[closest];
          if (layer && layer.setIcon) {
            layer.setIcon(L.divIcon({ html: `<div class="marker-dot" style="opacity:0.35;color:#003300"></div>`, className:'', iconSize:[18,18], iconAnchor:[9,9] }));
          }
          saveState();
        } else {
          document.getElementById('status').textContent = `${name} already claimed`;
        }
      }
    });

    // radiation zones
    const radiationZones = [
      L.circle([36.027, -115.04], { radius: 300, color:'#ff0066', fillColor:'#ff0066', fillOpacity:0.12 }).bindPopup("Radiation Hotspot").addTo(map),
      L.circle([35.2, -115.47], { radius: 500, color:'#ff0066', fillColor:'#ff0066', fillOpacity:0.08 }).bindPopup("Radiation Hotspot").addTo(map)
    ];
    function checkRadiation() {
      const center = map.getCenter();
      const inZone = radiationZones.some(z => map.distance(center, z.getLatLng()) < z.getRadius());
      document.body.style.boxShadow = inZone ? 'inset 0 0 120px rgba(255,0,90,0.18)' : 'none';
    }
    map.on('moveend', checkRadiation);

    // Phantom integration (real)
    const connectBtn = document.getElementById('connectPhantom');
    async function getProvider() {
      if (window.solana && window.solana.isPhantom) return window.solana;
      if (window.phantom && window.phantom.solana && window.phantom.solana.isPhantom) return window.phantom.solana;
      return null;
    }
    async function connectPhantom() {
      const provider = await getProvider();
      if (!provider) { document.getElementById('status').textContent = 'Status: Phantom not detected'; return; }
      try {
        const resp = await provider.connect();
        connectedWallet = resp.publicKey?.toString?.() || (provider.publicKey && provider.publicKey.toString && provider.publicKey.toString());
        updateWalletUI();
        provider.on && provider.on('disconnect', () => { connectedWallet = null; updateWalletUI(); });
      } catch (err) { document.getElementById('status').textContent = 'Status: wallet connection canceled or failed'; }
    }
    async function disconnectPhantom() {
      const provider = await getProvider();
      if (provider && provider.disconnect) { try { await provider.disconnect(); } catch(e) {} }
      connectedWallet = null; updateWalletUI();
    }
    function updateWalletUI() {
      if (connectedWallet) {
        const short = `${connectedWallet.slice(0,4)}...${connectedWallet.slice(-4)}`;
        connectBtn.textContent = `Disconnect ${short}`;
        document.getElementById('status').textContent = `Status: connected ${short}`;
      } else {
        connectBtn.textContent = 'Connect Phantom';
        document.getElementById('status').textContent = 'Status: ready';
      }
    }
    connectBtn.addEventListener('click', async () => { if (connectedWallet) await disconnectPhantom(); else await connectPhantom(); });

    // --- Persistence (localStorage) and stable ids for inventory items
    function ensureItemIds() {
      inventory.forEach((it, idx) => {
        if (!it.id) it.id = `item_${idx}_${it.name.replace(/\s+/g,'_')}`;
        if (!it.type) it.type = (it.rarity === 'epic' || it.rarity === 'legendary') ? 'equip' : 'consumable';
      });
    }
    ensureItemIds();

    function saveState() {
      try {
        localStorage.setItem('af_state', JSON.stringify({
          inventory,
          quests,
          claimed: Array.from(claimed),
          equippedItemId
        }));
      } catch(e) {}
    }
    function loadState() {
      try {
        const s = JSON.parse(localStorage.getItem('af_state') || 'null');
        if (s) {
          if (Array.isArray(s.inventory)) {
            // merge by id
            s.inventory.forEach(si => {
              const existing = inventory.find(x => x.id === si.id);
              if (existing) Object.assign(existing, si);
              else inventory.push(si);
            });
          }
          if (Array.isArray(s.quests)) {
            s.quests.forEach(sq => {
              const q = quests.find(x => x.id === sq.id);
              if (q) q.state = sq.state;
            });
          }
          if (Array.isArray(s.claimed)) {
            claimed = new Set(s.claimed);
          }
          if (s.equippedItemId) equippedItemId = s.equippedItemId;
        }
      } catch(e) {}
    }
    let equippedItemId = null;
    loadState();
    ensureItemIds();

    // --- Items: use/equip logic and rendering with event delegation
    function useItem(id) {
      const idx = inventory.findIndex(it => it.id === id);
      if (idx === -1) { document.getElementById('status').textContent = 'Status: item not found'; return; }
      const item = inventory[idx];

      if (item.type === 'consumable') {
        // Example effects (expand as needed)
        if (item.name.toLowerCase().includes('stimpak')) {
          document.getElementById('status').textContent = `Used ${item.name} — +HP`;
        } else if (item.name.toLowerCase().includes('radaway')) {
          document.getElementById('status').textContent = `Used ${item.name} — radiation reduced`;
        } else {
          document.getElementById('status').textContent = `Used ${item.name}`;
        }

        // decrement or remove
        if (typeof item.qty === 'number' && item.qty > 1) {
          item.qty -= 1;
        } else {
          inventory.splice(idx, 1);
        }
        saveState();
        // optional: check quests that might be satisfied by this use
        onItemUsedForQuest(item.name);
        // re-render if items panel open
        if (currentOpenPanel === 'items') renderItems();
        return;
      }

      if (item.type === 'equip') {
        equipItem(id);
        return;
      }

      document.getElementById('status').textContent = `Used ${item.name}`;
      saveState();
      if (currentOpenPanel === 'items') renderItems();
    }

    function equipItem(id) {
      const item = inventory.find(it => it.id === id);
      if (!item) { document.getElementById('status').textContent = 'Status: item not found'; return; }

      if (equippedItemId === id) {
        equippedItemId = null;
        item.equipped = false;
        document.getElementById('status').textContent = `Unequipped ${item.name}`;
      } else {
        if (equippedItemId) {
          const prev = inventory.find(it => it.id === equippedItemId);
          if (prev) prev.equipped = false;
        }
        equippedItemId = id;
        item.equipped = true;
        document.getElementById('status').textContent = `Equipped ${item.name}`;
      }
      saveState();
      if (currentOpenPanel === 'items') renderItems();
    }

    function onItemUsedForQuest(itemName) {
      // naive example: if quest description mentions the item name, mark complete
      quests.forEach(q => {
        if (q.state === 'accepted' && q.desc.toLowerCase().includes(itemName.toLowerCase())) {
          q.state = 'completed';
          document.getElementById('status').textContent = `Quest completed: ${q.title} — reward: ${q.reward}`;
        }
      });
      if (currentOpenPanel === 'quests') renderQuests();
      saveState();
    }

    // Render items into panelBody (used by openPanel)
    function renderItems() {
      const container = document.createElement('div');
      inventory.forEach(it => {
        const div = document.createElement('div');
        div.className = 'list-item';
        const left = document.createElement('div');
        left.innerHTML = `<strong>${it.name}</strong><div class="muted">${it.rarity}</div>`;
        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.alignItems = 'center';
        right.style.gap = '8px';

        const qty = document.createElement('div');
        qty.className = 'muted';
        qty.textContent = (typeof it.qty === 'number') ? `x${it.qty}` : '';
        right.appendChild(qty);

        if (it.type === 'consumable') {
          const useBtn = document.createElement('button');
          useBtn.textContent = 'Use';
          useBtn.dataset.action = 'use';
          useBtn.dataset.id = it.id;
          right.appendChild(useBtn);
        }

        if (it.type === 'equip') {
          const eqBtn = document.createElement('button');
          eqBtn.textContent = it.equipped ? 'Unequip' : 'Equip';
          eqBtn.dataset.action = 'equip';
          eqBtn.dataset.id = it.id;
          right.appendChild(eqBtn);
        }

        div.appendChild(left);
        div.appendChild(right);

        if (it.equipped) div.style.borderLeft = '4px solid #00ff41';

        container.appendChild(div);
      });
      const panelBody = document.getElementById('panelBody');
      if (panelBody) {
        panelBody.innerHTML = '';
        panelBody.appendChild(container);
      }
    }

    // Event delegation for panel actions
    document.getElementById('panelBody').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const action = btn.dataset.action;
      const id = btn.dataset.id;
      if (action === 'use') useItem(id);
      if (action === 'equip') equipItem(id);
      if (action === 'accept') acceptQuest(id);
      if (action === 'complete') completeQuest(id);
    });

    // --- Quests rendering and actions
    function renderQuests() {
      const container = document.createElement('div');
      quests.forEach(q => {
        const div = document.createElement('div');
        div.className = 'list-item' + (q.state === 'accepted' ? ' quest-accepted' : '');
        const left = document.createElement('div');
        left.style.flex = '1';
        left.innerHTML = `<strong>${q.title}</strong><div class="quest-meta">${q.desc}</div><div class="muted">Reward: ${q.reward}</div>`;
        const right = document.createElement('div');
        right.className = 'quest-actions';
        const stateLabel = document.createElement('div');
        stateLabel.className = 'muted';
        stateLabel.style.fontSize = '0.85rem';
        stateLabel.style.marginBottom = '6px';
        stateLabel.textContent = q.state.toUpperCase();
        right.appendChild(stateLabel);
        if (q.state === 'available') {
          const acceptBtn = document.createElement('button');
          acceptBtn.textContent = 'Accept';
          acceptBtn.dataset.action = 'accept';
          acceptBtn.dataset.id = q.id;
          right.appendChild(acceptBtn);
        } else if (q.state === 'accepted') {
          const completeBtn = document.createElement('button');
          completeBtn.textContent = 'Complete';
          completeBtn.dataset.action = 'complete';
          completeBtn.dataset.id = q.id;
          right.appendChild(completeBtn);
        } else {
          const done = document.createElement('div');
          done.textContent = '✓';
          right.appendChild(done);
        }
        div.appendChild(left);
        div.appendChild(right);
        container.appendChild(div);
      });
      const panelBody = document.getElementById('panelBody');
      if (panelBody) {
        panelBody.innerHTML = '';
        panelBody.appendChild(container);
      }
    }

    function acceptQuest(id) {
      const q = quests.find(x => x.id === id);
      if (!q) return;
      q.state = 'accepted';
      document.getElementById('status').textContent = `Quest accepted: ${q.title}`;
      saveState();
      if (currentOpenPanel === 'quests') renderQuests();
    }
    function completeQuest(id) {
      const q = quests.find(x => x.id === id);
      if (!q) return;
      q.state = 'completed';
      document.getElementById('status').textContent = `Quest completed: ${q.title} — reward: ${q.reward}`;
      saveState();
      if (currentOpenPanel === 'quests') renderQuests();
    }

    // --- Panel UI wiring (STAT / ITEMS / QUESTS)
    const sidePanel = document.getElementById('sidePanel');
    const panelTitle = document.getElementById('panelTitle');
    const panelBody = document.getElementById('panelBody');
    const panelClose = document.getElementById('panelClose');
    const tabs = document.querySelectorAll('.tab');
    let currentOpenPanel = null;

    function openPanel(name) {
      currentOpenPanel = name;
      tabs.forEach(t => t.classList.toggle('active', t.dataset.panel === name));
      panelBody.innerHTML = '';
      panelTitle.textContent = name.toUpperCase();
      if (name === 'stat') renderStats();
      else if (name === 'items') renderItems();
      else if (name === 'quests') renderQuests();
      sidePanel.style.display = 'block';
      sidePanel.setAttribute('aria-hidden','false');
    }
    function closePanel() {
      currentOpenPanel = null;
      sidePanel.style.display = 'none';
      sidePanel.setAttribute('aria-hidden','true');
      tabs.forEach(t => t.classList.toggle('active', t.id === 'tab-map'));
    }
    panelClose.addEventListener('click', closePanel);

    function renderStats() {
      const container = document.createElement('div');
      Object.keys(playerStats).forEach(k => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `<div><strong>${k}</strong></div><div class="muted">${playerStats[k]}</div>`;
        container.appendChild(div);
      });
      panelBody.appendChild(container);
    }

    // tab click handlers
    document.getElementById('tab-stat').addEventListener('click', () => openPanel('stat'));
    document.getElementById('tab-items').addEventListener('click', () => openPanel('items'));
    document.getElementById('tab-quests').addEventListener('click', () => openPanel('quests'));
    document.getElementById('tab-map').addEventListener('click', () => { closePanel(); document.getElementById('status').textContent = 'Status: map focused'; });

    // close panel on Escape
    window.addEventListener('keydown', e => { if (e.key === 'Escape') closePanel(); });

    // Boot sequence: load locations, then UI wiring and geolocation
    function boot() {
      ensureItemIds();
      loadState();
      loadLocations();
      // small nudge to ensure map paints correctly on load
      setTimeout(()=>map.invalidateSize(), 300);
      checkRadiation();

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          ensurePlayerMarker(pos.coords.latitude, pos.coords.longitude);
          setTimeout(()=>map.flyTo([pos.coords.latitude, pos.coords.longitude], 16, { duration: 0.7 }), 600);
        }, err => { document.getElementById('status').textContent = 'Status: GPS blocked or unavailable'; }, { enableHighAccuracy:true, timeout:5000 });

        navigator.geolocation.watchPosition(pos => {
          ensurePlayerMarker(pos.coords.latitude, pos.coords.longitude);
        }, ()=>{}, { enableHighAccuracy:true, maximumAge:3000, timeout:5000 });
      } else {
        document.getElementById('status').textContent = 'Status: geolocation not supported';
      }

      // ensure UI shows inventory/quests state if panel open
      if (currentOpenPanel === 'items') renderItems();
      if (currentOpenPanel === 'quests') renderQuests();
    }

    boot();
  </script>
</body>
</html>
